# ============================================
# AI Stock Keeper - Production Docker Compose
# Self-hosted VPS deployment
# ============================================
# Запуск: docker compose -f docker-compose.prod.yml up -d
#
# Внешние сервисы (подключаются через ENV):
# - PostgreSQL: DATABASE_URL
# - Redis: REDIS_URL

services:
  # ============================================
  # Nginx Reverse Proxy
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: ai-stock-keeper-nginx
    restart: unless-stopped
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      app:
        condition: service_healthy
    networks:
      - ai-stock-network
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================
  # Next.js Application (via PM2)
  # ============================================
  app:
    image: ghcr.io/hrustalq-lab/ai-stock-keeper:${APP_VERSION:-latest}
    container_name: ai-stock-keeper-app
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      # 1C интеграция
      ONE_C_BASE_URL: ${ONE_C_BASE_URL}
      ONE_C_USERNAME: ${ONE_C_USERNAME}
      ONE_C_PASSWORD: ${ONE_C_PASSWORD}
      ONE_C_WAREHOUSE_ID: ${ONE_C_WAREHOUSE_ID}
      ONE_C_WEBHOOK_SECRET: ${ONE_C_WEBHOOK_SECRET}
      ONE_C_AUTO_CREATE_SHIPMENT: ${ONE_C_AUTO_CREATE_SHIPMENT:-true}
      BULL_QUEUE_NAME: ${BULL_QUEUE_NAME:-1c-sync-queue}
      # Уведомления (Phase 3)
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-alerts@localhost}
      ALERT_DEFAULT_COOLDOWN_MINS: ${ALERT_DEFAULT_COOLDOWN_MINS:-60}
      # Прогнозирование (Phase 4)
      PROPHET_SERVICE_URL: ${PROPHET_SERVICE_URL:-}
      FORECAST_DEFAULT_HISTORY_DAYS: ${FORECAST_DEFAULT_HISTORY_DAYS:-60}
      FORECAST_DEFAULT_PERIODS: ${FORECAST_DEFAULT_PERIODS:-14}
      REORDER_DEFAULT_LEAD_TIME_DAYS: ${REORDER_DEFAULT_LEAD_TIME_DAYS:-7}
      REORDER_DEFAULT_SERVICE_LEVEL: ${REORDER_DEFAULT_SERVICE_LEVEL:-0.95}
      # Оптимизация маршрутов (Phase 5)
      ROUTE_OPTIMIZATION_ALGORITHM: ${ROUTE_OPTIMIZATION_ALGORITHM:-nearest_neighbor}
      WAREHOUSE_WALKING_SPEED_MPS: ${WAREHOUSE_WALKING_SPEED_MPS:-1.4}
      WAREHOUSE_PICK_TIME_SECONDS: ${WAREHOUSE_PICK_TIME_SECONDS:-15}
    networks:
      - ai-stock-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ============================================
  # Background Worker (Bull Queue)
  # ============================================
  worker:
    image: ghcr.io/hrustalq-lab/ai-stock-keeper:${APP_VERSION:-latest}
    container_name: ai-stock-keeper-worker
    restart: unless-stopped
    command: ["node", "worker.cjs"]
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: ${REDIS_URL}
      # 1C интеграция
      ONE_C_BASE_URL: ${ONE_C_BASE_URL}
      ONE_C_USERNAME: ${ONE_C_USERNAME}
      ONE_C_PASSWORD: ${ONE_C_PASSWORD}
      ONE_C_WAREHOUSE_ID: ${ONE_C_WAREHOUSE_ID}
      ONE_C_AUTO_CREATE_SHIPMENT: ${ONE_C_AUTO_CREATE_SHIPMENT:-true}
      BULL_QUEUE_NAME: ${BULL_QUEUE_NAME:-1c-sync-queue}
      # Уведомления (Phase 3)
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      RESEND_FROM_EMAIL: ${RESEND_FROM_EMAIL:-alerts@localhost}
      ALERT_DEFAULT_COOLDOWN_MINS: ${ALERT_DEFAULT_COOLDOWN_MINS:-60}
      # Прогнозирование (Phase 4)
      PROPHET_SERVICE_URL: ${PROPHET_SERVICE_URL:-}
      FORECAST_DEFAULT_HISTORY_DAYS: ${FORECAST_DEFAULT_HISTORY_DAYS:-60}
      FORECAST_DEFAULT_PERIODS: ${FORECAST_DEFAULT_PERIODS:-14}
      REORDER_DEFAULT_LEAD_TIME_DAYS: ${REORDER_DEFAULT_LEAD_TIME_DAYS:-7}
      REORDER_DEFAULT_SERVICE_LEVEL: ${REORDER_DEFAULT_SERVICE_LEVEL:-0.95}
      # Оптимизация маршрутов (Phase 5)
      ROUTE_OPTIMIZATION_ALGORITHM: ${ROUTE_OPTIMIZATION_ALGORITHM:-nearest_neighbor}
      WAREHOUSE_WALKING_SPEED_MPS: ${WAREHOUSE_WALKING_SPEED_MPS:-1.4}
      WAREHOUSE_PICK_TIME_SECONDS: ${WAREHOUSE_PICK_TIME_SECONDS:-15}
    networks:
      - ai-stock-network

networks:
  ai-stock-network:
    driver: bridge
