// Prisma Schema для AI Stock Keeper
// Документация: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Инвентарь (кеш из 1C)
// ============================================
model Inventory {
  id           Int       @id @default(autoincrement())
  sku          String    @db.VarChar(50)
  name         String    @db.VarChar(255)
  quantity     Int       @default(0)
  warehouse    String    @db.VarChar(50)
  reorderPoint Int       @default(10) @map("reorder_point")
  supplier     String?   @db.VarChar(100)
  syncedAt     DateTime  @default(now()) @map("synced_at")
  last1CUpdate DateTime? @map("last_1c_update")

  // Уникальный индекс: SKU + склад
  @@unique([sku, warehouse])
  @@index([sku])
  @@index([warehouse])
  @@map("inventory")
}

// ============================================
// Транзакции (локальные, до синхронизации с 1C)
// ============================================
model Transaction {
  id                 Int       @id @default(autoincrement())
  type               String    @db.VarChar(20) // intake, picking, transfer, adjustment
  sku                String    @db.VarChar(50)
  quantity           Int
  fromWarehouse      String?   @map("from_warehouse") @db.VarChar(50)
  toWarehouse        String?   @map("to_warehouse") @db.VarChar(50)
  documentId         String?   @map("document_id") @db.VarChar(100) // Ссылка на документ 1C
  syncedWith1C       Boolean   @default(false) @map("synced_with_1c")
  syncedAt           DateTime? @map("synced_at")
  createdAt          DateTime  @default(now()) @map("created_at")
  invoiceLineItemId  Int?      @map("invoice_line_item_id") // Traceability from invoice line
  oneCLineDocumentId String?   @map("one_c_line_document_id") @db.VarChar(100) // Idempotent retry

  invoiceLineItem InvoiceLineItem? @relation(fields: [invoiceLineItemId], references: [id])

  @@index([sku])
  @@index([syncedWith1C])
  @@index([invoiceLineItemId])
  @@unique([oneCLineDocumentId])
  @@map("transactions")
}

// ============================================
// Документы 1C
// ============================================
model Document1C {
  id            Int       @id @default(autoincrement())
  type          String    @db.VarChar(50) // GoodsReceipt, Shipment, Transfer
  docNumber     String    @map("doc_number") @db.VarChar(50)
  docDate       DateTime? @map("doc_date")
  warehouse     String?   @db.VarChar(50)
  status        String?   @db.VarChar(20) // draft, posted, processed
  syncAttempt   Int       @default(0) @map("sync_attempt")
  lastSyncError String?   @map("last_sync_error")
  syncedAt      DateTime? @map("synced_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  invoiceId     Int?      @map("invoice_id") // Links 1C document created from invoice processing

  invoice Invoice? @relation(fields: [invoiceId], references: [id])

  @@index([docNumber])
  @@index([invoiceId])
  @@map("documents_1c")
}

// ============================================
// Аудит лог
// ============================================
model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String   @db.VarChar(100)
  tableName String?  @map("table_name") @db.VarChar(50)
  recordId  String?  @map("record_id") @db.VarChar(100)
  oldValue  Json?    @map("old_value")
  newValue  Json?    @map("new_value")
  userId    String?  @map("user_id") @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at")

  @@map("audit_log")
}

// ============================================
// Очередь синхронизации (для Bull)
// ============================================
model SyncQueue {
  id           Int       @id @default(autoincrement())
  jobType      String    @map("job_type") @db.VarChar(50)
  payload      Json
  status       String    @default("pending") @db.VarChar(20) // pending, processing, completed, failed
  retryCount   Int       @default(0) @map("retry_count")
  errorMessage String?   @map("error_message")
  createdAt    DateTime  @default(now()) @map("created_at")
  processedAt  DateTime? @map("processed_at")

  @@index([status])
  @@map("sync_queue")
}

// ============================================
// Phase 3: Правила алертов
// ============================================
model AlertRule {
  id              Int       @id @default(autoincrement())
  name            String    @db.VarChar(100)
  sku             String?   @db.VarChar(50)   // null = все товары
  warehouse       String?   @db.VarChar(50)   // null = все склады
  condition       String    @db.VarChar(20)   // "below", "above", "equals"
  threshold       Int
  channel         String    @db.VarChar(20)   // "email", "webhook"
  recipient       String    @db.VarChar(255)  // email/url
  isActive        Boolean   @default(true) @map("is_active")
  cooldownMins    Int       @default(60) @map("cooldown_mins")
  lastTriggeredAt DateTime? @map("last_triggered_at")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  @@index([sku])
  @@index([isActive])
  @@map("alert_rules")
}

// ============================================
// Phase 3: История алертов
// ============================================
model AlertHistory {
  id           Int      @id @default(autoincrement())
  ruleId       Int      @map("rule_id")
  ruleName     String   @map("rule_name") @db.VarChar(100)
  sku          String   @db.VarChar(50)
  productName  String?  @map("product_name") @db.VarChar(255)
  warehouse    String   @db.VarChar(50)
  oldValue     Int      @map("old_value")
  newValue     Int      @map("new_value")
  threshold    Int
  channel      String   @db.VarChar(20)
  status       String   @db.VarChar(20) // "sent", "failed"
  errorMessage String?  @map("error_message")
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([ruleId])
  @@index([createdAt])
  @@map("alert_history")
}

// ============================================
// Phase 3: Снапшоты инвентаря
// ============================================
model InventorySnapshot {
  id         Int      @id @default(autoincrement())
  warehouse  String   @db.VarChar(50)
  snapshot   Json     // { "SKU-001": 100, "SKU-002": 50, ... }
  totalItems Int      @map("total_items")
  totalQty   Int      @map("total_qty")
  source     String   @db.VarChar(20) // "local", "1c"
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([warehouse])
  @@index([createdAt])
  @@map("inventory_snapshots")
}

// ============================================
// Phase 4: Дневное потребление (агрегация)
// ============================================
model DailyConsumption {
  id        Int      @id @default(autoincrement())
  sku       String   @db.VarChar(50)
  warehouse String   @db.VarChar(50)
  date      DateTime @db.Date
  consumed  Int      // Количество отгруженного/потреблённого
  received  Int      @default(0) // Количество поступившего
  netChange Int      @map("net_change") // consumed - received
  avgPrice  Decimal? @map("avg_price") @db.Decimal(10, 2)

  @@unique([sku, warehouse, date])
  @@index([sku])
  @@index([warehouse])
  @@index([date])
  @@map("daily_consumption")
}

// ============================================
// Phase 4: Прогнозы
// ============================================
model Forecast {
  id             Int      @id @default(autoincrement())
  sku            String   @db.VarChar(50)
  warehouse      String   @db.VarChar(50)
  forecastDate   DateTime @map("forecast_date") @db.Date
  predictedQty   Int      @map("predicted_qty")
  confidenceLow  Int?     @map("confidence_low")
  confidenceHigh Int?     @map("confidence_high")
  model          String   @db.VarChar(20) // "sma", "ema", "prophet"
  mape           Decimal? @db.Decimal(5, 2) // Model accuracy
  createdAt      DateTime @default(now()) @map("created_at")

  @@unique([sku, warehouse, forecastDate, model])
  @@index([sku])
  @@index([forecastDate])
  @@map("forecasts")
}

// ============================================
// Phase 4: Рекомендации по дозаказу
// ============================================
model ReorderRecommendation {
  id             Int       @id @default(autoincrement())
  sku            String    @db.VarChar(50)
  warehouse      String    @db.VarChar(50)
  currentQty     Int       @map("current_qty")
  reorderPoint   Int       @map("reorder_point")
  recommendedQty Int       @map("recommended_qty")
  daysToStockout Int       @map("days_to_stockout")
  urgency        String    @db.VarChar(20) // "critical", "warning", "normal"
  status         String    @default("pending") @db.VarChar(20) // "pending", "approved", "ordered"
  expiresAt      DateTime  @map("expires_at")
  createdAt      DateTime  @default(now()) @map("created_at")

  @@index([sku])
  @@index([urgency])
  @@index([status])
  @@map("reorder_recommendations")
}

// ============================================
// Invoice processing: Purchase orders (from 1C or manual)
// ============================================
model PurchaseOrder {
  id            Int       @id @default(autoincrement())
  poNumber      String    @unique @map("po_number") @db.VarChar(50)
  supplier      String    @db.VarChar(255)
  warehouse     String    @db.VarChar(50)
  orderDate     DateTime  @map("order_date")
  expectedDate  DateTime? @map("expected_date")
  status        String    @db.VarChar(20) // open, partial, fulfilled, cancelled
  totalAmount   Decimal?  @map("total_amount") @db.Decimal(12, 2)
  oneCDocumentId String?  @map("one_c_document_id") @db.VarChar(100)
  syncedAt      DateTime  @default(now()) @map("synced_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  items   PurchaseOrderItem[]
  invoices Invoice[]

  @@index([poNumber])
  @@index([supplier])
  @@index([status])
  @@map("purchase_orders")
}

// ============================================
// Invoice processing: Purchase order line items
// ============================================
model PurchaseOrderItem {
  id              Int      @id @default(autoincrement())
  purchaseOrderId Int      @map("purchase_order_id")
  sku             String   @db.VarChar(50)
  productName     String   @map("product_name") @db.VarChar(255)
  orderedQty      Int      @map("ordered_qty")
  receivedQty     Int      @default(0) @map("received_qty")
  unitPrice       Decimal  @map("unit_price") @db.Decimal(10, 2)
  vatRate         Decimal  @map("vat_rate") @db.Decimal(5, 2)

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])

  @@index([purchaseOrderId])
  @@index([sku])
  @@map("purchase_order_items")
}

// ============================================
// Invoice processing: Invoices (uploaded/OCR, matched to PO)
// Workflow states: pending → processing → review → approved → completed | failed
// ============================================
model Invoice {
  id               Int       @id @default(autoincrement())
  invoiceNumber    String    @map("invoice_number") @db.VarChar(50)
  invoiceDate      DateTime  @map("invoice_date")
  invoiceType      String    @map("invoice_type") @db.VarChar(20) // TORG12, TTN, INVOICE
  supplier         String    @db.VarChar(255)
  warehouse        String    @db.VarChar(50)
  filePath         String    @map("file_path") @db.VarChar(500)
  fileSize         Int       @map("file_size")
  fileType         String    @map("file_type") @db.VarChar(20) // pdf, jpeg, png
  processingStatus String   @default("pending") @map("processing_status") @db.VarChar(20) // pending, processing, review, approved, completed, failed
  ocrMethod        String?   @map("ocr_method") @db.VarChar(20) // tesseract, cloud, text_extraction
  ocrConfidence    Decimal?  @map("ocr_confidence") @db.Decimal(5, 2)
  totalAmount      Decimal?  @map("total_amount") @db.Decimal(12, 2)
  totalVat         Decimal?  @map("total_vat") @db.Decimal(12, 2)
  matchedPoId      Int?      @map("matched_po_id")
  hasDiscrepancies Boolean  @default(false) @map("has_discrepancies")
  documentId       String?   @map("document_id") @db.VarChar(100) // 1C document ID after approval
  createdAt        DateTime  @default(now()) @map("created_at")
  processedAt      DateTime? @map("processed_at")
  approvedAt       DateTime? @map("approved_at")

  lineItems   InvoiceLineItem[]
  matchedPo   PurchaseOrder?    @relation(fields: [matchedPoId], references: [id])
  documents1C Document1C[]

  @@index([invoiceNumber])
  @@index([supplier])
  @@index([processingStatus])
  @@index([matchedPoId])
  @@map("invoices")
}

// ============================================
// Invoice processing: Invoice line items (OCR or manual, editable)
// ============================================
model InvoiceLineItem {
  id             Int     @id @default(autoincrement())
  invoiceId      Int     @map("invoice_id")
  lineNumber     Int     @map("line_number")
  sku            String  @db.VarChar(50)
  productName    String  @map("product_name") @db.VarChar(255)
  quantity       Int
  unitPrice      Decimal @map("unit_price") @db.Decimal(10, 2)
  vatRate        Decimal @map("vat_rate") @db.Decimal(5, 2)
  vatAmount      Decimal @map("vat_amount") @db.Decimal(10, 2)
  lineTotal      Decimal @map("line_total") @db.Decimal(12, 2)
  isEdited       Boolean @default(false) @map("is_edited")
  originalSku    String?  @map("original_sku") @db.VarChar(50)
  originalQty    Int?     @map("original_qty")
  status         String  @default("pending") @db.VarChar(20) // pending, approved, edited, skipped
  expectedQty    Int?     @map("expected_qty")
  qtyDiscrepancy Int?     @map("qty_discrepancy")

  invoice      Invoice       @relation(fields: [invoiceId], references: [id])
  transactions Transaction[]

  @@unique([invoiceId, lineNumber])
  @@index([invoiceId])
  @@index([sku])
  @@map("invoice_line_items")
}

// ============================================
// Phase 5: Локации товаров на складе
// ============================================
model WarehouseLocation {
  id           Int      @id @default(autoincrement())
  warehouse    String   @db.VarChar(50)
  locationCode String   @map("location_code") @db.VarChar(20) // "A-01-02" (зона-ряд-полка)
  zone         String   @db.VarChar(10)     // "A", "B", "C" - зоны склада
  aisle        Int      // Ряд
  shelf        Int      // Полка
  position     Int      @default(1)         // Позиция на полке

  // Координаты для расчёта расстояния (опционально)
  coordX Float? @map("coord_x")
  coordY Float? @map("coord_y")

  // Метаданные
  maxCapacity  Int?    @map("max_capacity")
  locationType String  @default("shelf") @map("location_type") @db.VarChar(20) // "shelf", "pallet", "bin", "floor"
  isActive     Boolean @default(true) @map("is_active")

  // SKU на этой локации
  inventoryLocations InventoryLocation[]

  @@unique([warehouse, locationCode])
  @@index([warehouse])
  @@index([zone])
  @@map("warehouse_locations")
}

// ============================================
// Phase 5: Связь товаров с локациями
// ============================================
model InventoryLocation {
  id         Int     @id @default(autoincrement())
  sku        String  @db.VarChar(50)
  locationId Int     @map("location_id")
  quantity   Int     @default(0)
  isPrimary  Boolean @default(true) @map("is_primary") // Основная локация товара

  location WarehouseLocation @relation(fields: [locationId], references: [id])

  @@unique([sku, locationId])
  @@index([sku])
  @@index([locationId])
  @@map("inventory_locations")
}

// ============================================
// Phase 5: Лист сборки (Picking List)
// ============================================
model PickingList {
  id          Int     @id @default(autoincrement())
  listNumber  String  @unique @map("list_number") @db.VarChar(30) // "PL-2026-01-31-001"
  warehouse   String  @db.VarChar(50)

  // Тип сборки
  pickingType String  @map("picking_type") @db.VarChar(20) // "single", "batch", "wave"

  // Статус
  status   String @default("created") @db.VarChar(20) // "created", "assigned", "in_progress", "completed", "cancelled"
  priority Int    @default(0) // 0-низкий, 1-нормальный, 2-высокий, 3-срочный

  // Назначение
  assignedTo String?   @map("assigned_to") @db.VarChar(100) // Worker ID/name
  assignedAt DateTime? @map("assigned_at")

  // Время
  startedAt     DateTime? @map("started_at")
  completedAt   DateTime? @map("completed_at")
  estimatedMins Int?      @map("estimated_mins") // Оценка времени сборки
  actualMins    Int?      @map("actual_mins")    // Фактическое время

  // Маршрут
  optimizedRoute Json?  @map("optimized_route") // Последовательность локаций
  totalDistance  Float? @map("total_distance")  // Расчётное расстояние (метры)

  // Связи
  items  PickingItem[]
  orders PickingOrder[]

  // Метаданные
  notes     String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([warehouse])
  @@index([status])
  @@index([assignedTo])
  @@index([createdAt])
  @@map("picking_lists")
}

// ============================================
// Phase 5: Позиции в листе сборки
// ============================================
model PickingItem {
  id            Int @id @default(autoincrement())
  pickingListId Int @map("picking_list_id")

  // Товар
  sku         String @db.VarChar(50)
  productName String @map("product_name") @db.VarChar(255)

  // Количество
  requiredQty Int @map("required_qty")  // Требуется собрать
  pickedQty   Int @default(0) @map("picked_qty") // Фактически собрано

  // Локация
  locationCode String @map("location_code") @db.VarChar(20)
  zone         String @db.VarChar(10)

  // Порядок обхода
  sequenceNum Int @map("sequence_num") // Порядковый номер в маршруте

  // Статус
  status String @default("pending") @db.VarChar(20) // "pending", "picked", "skipped", "shortage"

  // Подтверждение
  confirmedAt DateTime? @map("confirmed_at")
  confirmedBy String?   @map("confirmed_by") @db.VarChar(100)
  barcodeScan String?   @map("barcode_scan") @db.VarChar(100) // Отсканированный штрихкод

  // Проблемы
  issueType String? @map("issue_type") @db.VarChar(30) // "not_found", "wrong_location", "damaged", "shortage"
  issueNote String? @map("issue_note") @db.Text

  // Связи
  pickingList PickingList @relation(fields: [pickingListId], references: [id])

  @@index([pickingListId])
  @@index([sku])
  @@index([status])
  @@map("picking_items")
}

// ============================================
// Phase 5: Заказы в листе сборки (для batch picking)
// ============================================
model PickingOrder {
  id            Int @id @default(autoincrement())
  pickingListId Int @map("picking_list_id")

  // Заказ из 1C
  orderNumber  String  @map("order_number") @db.VarChar(50)
  customerName String? @map("customer_name") @db.VarChar(255)

  // Статус в контексте сборки
  status String @default("pending") @db.VarChar(20) // "pending", "in_progress", "completed"

  // Связь с документом 1C (после завершения)
  shipmentDocId String? @map("shipment_doc_id") @db.VarChar(100)

  // Связи
  pickingList PickingList @relation(fields: [pickingListId], references: [id])

  @@index([pickingListId])
  @@index([orderNumber])
  @@map("picking_orders")
}

// ============================================
// Phase 5: История сборок (аналитика)
// ============================================
model PickingHistory {
  id            Int    @id @default(autoincrement())
  pickingListId Int    @map("picking_list_id")
  workerId      String @map("worker_id") @db.VarChar(100)
  warehouse     String @db.VarChar(50)

  // Метрики
  itemCount     Int @map("item_count")
  totalQty      Int @map("total_qty")
  pickingMins   Int @map("picking_mins")
  errorCount    Int @default(0) @map("error_count")
  shortageCount Int @default(0) @map("shortage_count")

  // Расчётные метрики
  picksPerHour Float @map("picks_per_hour")
  accuracy     Float // 0.0 - 1.0

  // Сравнение с оценкой
  estimatedMins Int   @map("estimated_mins")
  efficiency    Float // actual vs estimated (< 1.0 = быстрее ожидаемого)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([workerId])
  @@index([warehouse])
  @@index([createdAt])
  @@map("picking_history")
}
